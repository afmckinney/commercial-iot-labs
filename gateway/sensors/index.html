<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Intel® Commercial IoT Workshop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">

    <!-- Include CodeMirror CSS-->
    <link rel="stylesheet" href="/css/codemirror.css">
  </head>
  <body>
    <header>
      <a href="/index.html"><img src="/img/intel_logo.png" alt="Intel logo" width="52" height="35"></a>
    </header>
    <div class="content">

      <h1>Sensor Monitoring on the Gateway</h1>

      <h2><a name="models">Create a Project Directory and Install MongooseJS</a></h2>

      <p>MongooseJS is an Object Data Manager that let’s you build JavaScript objects that can create, read, validate, update and remove documents from a MongoDB.</p>

      <p>Read through the documentation on building Mongoose Schemas and Models at <a href="http://mongoosejs.com/docs/guide.html">http://mongoosejs.com/docs/guide.html</a> then start the exercise.</p>

      <p>Be sure that you whitelist the <code>/usr/bin/node</code> executable:</p>

      <pre><code>$ paxctl -Cm /usr/bin/node</code></pre>

      <p>Also create a project directory.</p>

      <pre><code>$ mkdir project</code></pre>

      <p>Create a README file and write into it that this project contains the models for the edge network.</p>

      <p>Install MongooseJS</p>
      <pre><code>$ npm install mongoose --save</code></pre>

      <p>Create a <code>schema</code> directory and change to that directory, <code>cd schema</code>. We will store all of our schema files here. </p>
      <pre><code>$ mkdir schema</code></pre>


      <h2><a name="models">Write Mongoose JS Models to Access MongoDB</a></h2>
      <p>MongooseJS is an schema-based solution to model MongoDB database objects.  It allows you to easily create, validate, save, update and remove items from your MongoDB.  Everything in MongooseJS starts with a schema.  After a schema is defined it can be used to create a Model, which is the object you will use in your program to access the database.</p>

      <h3>Build the Sensor Model</h3>
      <p>If you have any questions be sure you consult the <a href="http://mongoosejs.com/docs/guide.html">The MongooseJS User Guide</a>.</p>


      <p>Let's build a schema for a sensor with the following data types:</p>
      <ul>
        <li>id : String</li>
        <li>name : String</li>
        <li>description : String</li>
        <li>maxfrequency : Number</li>
        <li>active : Boolean</li>
        <li>ioType String.</li>
      </ul>

      <div>
        <p class="label">schema/sensorSchema.js</p>
        <textarea id="code1" name="code">
var mongoose = require('mongoose');
var sensorSchema = new mongoose.Schema({
    id : {
        type: String,
        required: true
    },
    name  : {
        type: String,
        required: true
    },
    description : {
        type: String,
        required: true
    },
    maxfrequency : {
        type: Number,
        required: true
    },
    frequency : {
        type: Number,
        required: true
    },
    active : {
        type: Boolean,
        required: true
    },
    ioType : {
        type: String,
        required: true
    }
});

module.exports = sensorSchema;
      </textarea></div>

      <p>Save this code in the file <code>sensorSchema.js</code> in the <code>schema</code> directory.</p>

      <h3>Build the Rest of the Models</h3>

      <p>Here are the rest of the fields for the other types. Please, define them in a similar manner to the <code>sensorSchema</code>.</p>
      <li>
        <p>Define an actuator schema in <code>schema/actuatorSchema.js</code></p>
        <ul>
          <li>id : String</li>
          <li>name : String</li>
          <li>description : String</li>
          <li>maxfrequency : Number</li>
          <li>active : Boolean</li>
          <li>ioType String.</li>
        </ul>
      </li>

      <li>
        <p>Define sensor data schema in <code>schema/dataSchema.js</code></p>
        <ul>
          <li>sensor_id: String</li>
          <li>value: Number</li>
          <li>timestamp: Date</li>
        </ul>
      </li>

      <li>
        <p>Define a Trigger schema in <code>schema/dataSchema.js</code></p>
        <ul>
          <li>id: String. Holds a unique value for the iot network event</li>
          <li>name: String. A name for the iot network event</li>
          <li>sensor_id: String. A reference to the sensor that will trigger this event</li>
          <li>actuator_id: String. A reference to the actuator that will be activated</li>
          <li>condition: String. A JavaScript function that returns true or false</li>
          <li>triggerFunc: String. A JavaScript function that is executed when the condition is true.</li>
          <li>active: Boolean. If true this Iot Network Event can be triggered, otherwise it is inactive</li>
        </ul>
      </li>

      <li>
        <p>Define a schema for error in <code>schema/errorSchema.js</code></p>
        <ul>
          <li>type: String</li>
          <li>message: String</li>
          <li>timestamp: Date</li>
        </ul>
      </li>

      <h2>Create a Module Interface for the Edge Network Objects</h2>
      <p>In this section there are two goals.  First, we need to package these schemas into a JavaScript module that can be exported and used by other JavaScript Projects. Second, each schema object needs to be coverted into a Model object that can be used to access the database.</p>

      <p>Write this code to <code>/index.js</code> at the root level of this project.</p>

        <textarea id="code2" name="code">
var mongoose = require('mongoose');

var SensorSchema = require('./schema/sensorSchema.js');
var ActuatorSchema = require('./schema/actuatorSchema.js');
var TriggerSchema = require('./schema/triggerSchema.js');
var DataSchema = require('./schema/dataSchema.js');
var SensorCloudSchema = require('./schema/sensorCloudSchema.js');
var ErrorSchema = require('./schema/errorSchema.js');

module.exports = {
    SensorModel: mongoose.model('SensorModel', SensorSchema),
    ActuatorModel: mongoose.model('ActuatorModel', ActuatorSchema),
    DataModel: mongoose.model('DataModel', DataSchema),
    SensorCloudModel: mongoose.model('SensorCloudModel', SensorCloudSchema),
    TriggerModel: mongoose.model('TriggerModel', TriggerSchema),
    ErrorModel:  mongoose.model('ErrorModel', ErrorSchema)
};
      </textarea></div>


      <h3>Additional resources</h3>

      <ul>
        <li><a href="http://mongoosejs.com/docs/guide.html">http://mongoosejs.com/docs/guide.html</a></li>
      </ul>

      <h2><a name="sensorMonitor">Write Edge Device Daemon</a></h2>

      <p>The purpose of this daemon is to track edge network sensors and to record their data into the MongoDB database that you setup.</p>

      <ol>

        <li>
          <p>Write a NodeJS application that listens to two topics: "announcements" and “sensors/+/data”.</p>
          <p>The first topic will be published on if a new network sensor come online in the edge network.</p>
          <p>Notice the second topic has a “+” in it.  This is a wildcard character, and it means that any alphanumeric sequence will match it.  For the purposes of the IoT network we are designing, a sensor’s unique id should go here. So that if we want to listen to the data from a particular sensor we can listen to a topic like “sensors/temperature/data” or if we want to listen to the data from all sensors we can listen to “sensors/+/data”.</p>
        </li>

        <li>
          <p>When a new sensor or a new sensor value arrives, write it to the database.</p>
        </li>

      </ol>


      <h2><a name="sensors">Provision an Edge Sensor to the Network and Publish Sensor Data using MQTT</a></h2>

      <p>In this exercise, you will write an MQTT server that publishes temperature data to the edge network.</p>

      <p>Here are the steps in this exercise:</p>

      <ol>
        <li><p>Add the MQTT NPM package to the dependencies section of the <strong>package.json</strong> file.</p></li>
        <li><p>Import the MQTT and the <strong>jsupm_grove</strong> packages with the <strong>require</strong> statement.</p></li>
        <li><p>Initialize the temperature sensor.</p></li>
        <li><p>Connect to the Mosquitto database.</p></li>
        <li><p>Publish a sensor announcement.</p></li>
        <li><p>Write an event handler that responses to the MQTT connect event.</p></li>
        <li><p>Inside the event, write a <strong>setInterval</strong> function that publishes the sensor data.</p></li>
      </ol>


      <h2>References</h2>

      <ul>
        <li><p><a href="https://www.npmjs.com/package/mqtt">https://www.npmjs.com/package/mqtt</a></p></li>
        <li><p><a href="https://software.intel.com/en-us/iot/hardware/sensors">https://software.intel.com/en-us/iot/hardware/sensors</a></p></li>
        <li><p><a href="https://software.intel.com/en-us/iot/hardware/sensors/grove-temperature-sensor">https://software.intel.com/en-us/iot/hardware/sensors/grove-temperature-sensor</a></p></li>
      </ul>


      <h2><a name="actuators">Controlling Edge Network Devices Actuators with Restful HTTP</a></h2>

      <p>In this exercise, you will create a restful HTTP API to control an actuator deployed on an edge network.</p>

      <p>Here are the steps in this exercise:</p>

      <ol>
        <li><p>List the actions that the actuator can performs and create a Restful API that calls each action.</p></li>
        <li><p>Import the Express Node module, and setup the server to respond to the Restful API.</p></li>
        <li><p>Create API Endpoints for server that correspond to the API you defined for the actuator.</p></li>
        <li><p>Implement each API endpoint.</p></li>
      </ol>


      <h2>References</h2>

      <ul>
        <li><p><a href="https://www.npmjs.com/package/express">https://www.npmjs.com/package/express</a></p></li>
        <li><p><a href="https://en.wikipedia.org/wiki/Representational_state_transfer">https://en.wikipedia.org/wiki/Representational_state_transfer</a></p></li>
      </ul>

      <div class="callout done has-goto-button">
        <p>Ready for the next module?</p>
        <p><a href="../index.html#done-module-edge" class="link-button centered">Go to next module »</a></p>
      </div>

    </div>
    <script src="/js/codemirror.js"></script>
    <script src="/js/mode/javascript/javascript.js"></script>
    <script>
      var editors = ["code1", "code2"]

      for (i in editors) {
          console.log(editors[i]);
          CodeMirror.fromTextArea(document.getElementById(editors[i]), {
              lineNumbers: true,
              matchBrackets: true,
              continueComments: "Enter",
              extraKeys: {"Ctrl-Q": "toggleComment"}
          });
      };
    </script>
  </body>
</html>
