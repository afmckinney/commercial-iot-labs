<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Intel® Commercial IoT Workshop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <header>
      <a href="/index.html"><img src="/img/intel_logo.png" alt="Intel® logo" width="52" height="35"></a>
    </header>
    <div class="content">

      <h1>Read sensor data over BLE</h1>

      <div class="tldr">
        <p>Building off of the <span class="icon bookmark"><a href="/sensors/temp_sensor/index.html">Temperature Sensor and LCD</a></span> Intel® Commercial IoT Workshop exercise, turn your Intel® Edison into a BLE peripheral.</p>
      </div>

      <h2>Confirm your set up</h2>

      <ol>

        <li>
          <p>The <strong>Grove Temperature Sensor</strong> should be connected to analog pin <strong>A0</strong>.</p>
          <p>And the <strong>Grove LCD</strong> should be connected to any <strong>I2C</strong> pin.</p>
          <p><img src="/sensors/temp_sensor/image_2.jpg" alt="" ></p>
        </li>

        <li>
          <p>Your <span class="icon file">main.js</span> (running on the Intel® Edison) from <span class="icon bookmark">Temperature Sensor and LCD</span> should look like this:</p>
<pre><code>// Include the JavaScript UPM libraries
var groveSensor = require('jsupm_grove');
var LCD = require("jsupm_i2clcd");

// Create a new instance of a Grove Temperature Sensor
var temp = new groveSensor.GroveTemp(0);

// Create a new instance of a Grove RGB LCD screen
var screen = new LCD.Jhd1313m1(6, 0x3E, 0x62);

function monitor() {
    setInterval(function() {
      
        // Read the temperature sensor
        var celsius = temp.value();
        var fahrenheit = Math.round(celsius * 9.0/5.0 + 32.0);
        console.log(celsius + "° Celsius, or " + fahrenheit + "° Fahrenheit");
        
        // Update the LCD screen
        screen.setCursor(0, 0);
        screen.setColor(255, 255, 255);
        screen.write("Temp: " + celsius + "C or " + fahrenheit + "F");

    }, 1000);
}

monitor();
</code></pre>
        </li>

      </ol>

      <h2>Turn the Intel® Edison into a BLE peripheral</h2>

      <p>Use <a href="https://github.com/sandeepmistry/bleno">bleno</a>, a NodeJS module, to turn the Intel® Edison into a BLE peripheral.</p>

      <ol>

        <li>
          <p>In your Intel XDK project, open <span class="icon file">package.json</span> and locate the <code>dependencies</code> configuration.</p>
<pre><code>  "dependencies": {
  }</code></pre>
        </li>

        <li>
          <p>Add the <code>bleno</code> NodeJS module to the dependencies list.</p>
<pre><code class="highlight-diff">  "dependencies": {
    <strong>"bleno":"*"</strong>
  }</code></pre>
        </li>

        <li>
          <p>In <span class="icon file">main.js</span>, add <code>bleno</code> alongside the rest of your module imports.</p>
<pre><code class="highlight-diff">// Include the JavaScript UPM libraries
var groveSensor = require('jsupm_grove');
var LCD = require("jsupm_i2clcd");

<strong>// Include the libraries for BLE
var bleno = require('bleno');</strong>

// Create a new instance of a Grove Temperature Sensor
var temp = new groveSensor.GroveTemp(0);
var celsius = null;

// Create a new instance of a Grove RGB LCD screen
var screen = new LCD.Jhd1313m1(6, 0x3E, 0x62);
</code></pre>
        </li>

        <li>
          <p>Declare references to the bleno BLE classes for <code>PrimaryService</code>, <code>Characteristic</code>, <code>Descriptor</code>.</p>
<pre><code class="highlight-diff">// Include the libraries for BLE
var bleno = require('bleno');

// Create a new instance of a Grove Temperature Sensor
var temp = new groveSensor.GroveTemp(0);
var celsius = null;

// Create a new instance of a Grove RGB LCD screen
var screen = new LCD.Jhd1313m1(6, 0x3E, 0x62);

<strong>// Extend the bleno BLE classes
var BlenoPrimaryService = bleno.PrimaryService;
var BlenoCharacteristic = bleno.Characteristic;
var BlenoDescriptor = bleno.Descriptor;</strong>
</code></pre>
        </li>

        <li>
          <p>You will need to inherit from the bleno BLE classes, so add <code>util</code> to your module imports.</p>
<pre><code class="highlight-diff">// Include the libraries for BLE
var bleno = require('bleno');
<strong>var util = require('util');</strong>
</code></pre>
        </li>

        <li>
          <p>Use <code>util</code> to extend bleno's <code>PrimaryService</code> and <code>Characteristic</code>.</p>
          <p><code>TemperatureService()</code> and <code>TemperatureReadCharacteristic()</code> have been defined for you below.</p>
<pre><code class="highlight-diff">// Extend the bleno BLE classes
var BlenoPrimaryService = bleno.PrimaryService;
var BlenoCharacteristic = bleno.Characteristic;
var BlenoDescriptor = bleno.Descriptor;

<strong>util.inherits(TemperatureReadCharacteristic, BlenoCharacteristic);
util.inherits(TemperatureService, BlenoPrimaryService);

function TemperatureService(){
    TemperatureService.super_.call(this, {
        uuid: 'ec00',
        characteristics: [
          new TemperatureReadCharacteristic()
        ]
    });
}

function TemperatureReadCharacteristic(){
    TemperatureReadCharacteristic.super_.call(this,{
        uuid: 'ec01',
        properties: ['read'],
        descriptors: [
            new BlenoDescriptor({
                uuid: 'ec02',
                value: 'Temperature Read'
            })
        ]
    });
}</strong>

function monitor() {
    //...
}

monitor();
</code></pre>
        </li>


        <li>
          <p>bleno will need to write the sensor value to a buffer so declare a global variable <code>celsius</code> to use in <code>TemperatureReadCharacteristic.prototype.onReadRequest</code> defined below.</p>
          <p>Update <code>monitor()</code> to use the global variable instead of a local variable.</p>
<pre><code class="highlight-diff">// Create a new instance of a Grove Temperature Sensor
var temp = new groveSensor.GroveTemp(0);
<strong>var celsius = null;</strong>

// Create a new instance of a Grove RGB LCD screen
var screen = new LCD.Jhd1313m1(6, 0x3E, 0x62);

util.inherits(TemperatureReadCharacteristic, BlenoCharacteristic);
util.inherits(TemperatureService, BlenoPrimaryService);

// Extend the bleno BLE classes
var BlenoPrimaryService = bleno.PrimaryService;
var BlenoCharacteristic = bleno.Characteristic;
var BlenoDescriptor = bleno.Descriptor;

function TemperatureService(){
    //...
}

function TemperatureReadCharacteristic(){
    //...
}

<strong>TemperatureReadCharacteristic.prototype.onReadRequest = function(offset,callback){
    if (offset){
        callback(BlenoCharacteristic.RESULT_ATTR_NOT_LONG, null);
    }
    else{
        if (null !== celsius){
            var buffer = new Buffer(1);
            buffer.writeUInt8(celsius,0);
            callback(BlenoCharacteristic.RESULT_SUCCESS, buffer);
        }
    }
};</strong>

function monitor() {
    setInterval(function() {
      
        // Read the temperature sensor
        <strike>var celsius = temp.value();</strike>
        <strong>celsius = temp.value();</strong>
        var fahrenheit = Math.round(celsius * 9.0/5.0 + 32.0);
        console.log(celsius + "° Celsius, or " + fahrenheit + "° Fahrenheit");
        
        // Update the LCD screen
        screen.setCursor(0, 0);
        screen.setColor(255, 255, 255);
        screen.write("Temp: " + celsius + "C or " + fahrenheit + "F");

    }, 1000);
}

monitor();
</code></pre>
        </li>

        <li>
          <p>Finally, add event listeners for the <code>stateChange</code> and <code>advertisingStart</code> bleno BLE events.</p>
          <p>The callback function for the <code>stateChange</code> event implements a <code>setInterval()</code> so remove the <code>monitor();</code> statement and the <code>setInterval()</code> from <code>monitor()</code>.</p>
<pre><code class="highlight-diff">function monitor() {
    <strike>setInterval(function() {</strike>
      
        // Read the temperature sensor
        celsius = temp.value();
        var fahrenheit = Math.round(celsius * 9.0/5.0 + 32.0);
        console.log(celsius + "° Celsius, or " + fahrenheit + "° Fahrenheit");
        
        // Update the LCD screen
        screen.setCursor(0, 0);
        screen.setColor(255, 255, 255);
        screen.write("Temp: " + celsius + "C or " + fahrenheit + "F");

    <strike>}, 1000);</strike>
}

<strike>monitor();</strike>

<strong>bleno.on('stateChange', function(state) {
    if (state == 'poweredOn') {
        bleno.startAdvertising('temperature', [], function(err) {
            if (err) {
                console.log(err);
            }
            setInterval(monitor, 1000);
        });
    }
    else {
        bleno.stopAdvertising();
    }
});

bleno.on('advertisingStart', function(err) {
    if (!err) {
        console.log('Advertising...');
        bleno.setServices([
            new TemperatureService()
        ]);
    }
});</strong>
</code></pre>
        </li>

        <li>
          <p>Your final <span class="icon file">main.js</span> should look like the <a href="https://github.com/Vaghesh/Bluetooth-Commercial-IoT-Workshop/blob/master/Temperature-Sensor/EdgeDevices-Peripheral/" target="_blank">final solution on Github</a>.</p>
          <p>Make sure your changes have been saved and use the buttons at the bottom of the Intel® XDK to:<br>
            (1) Build your application, <br>
             <span class="footnote">(It is important to run Build at least once since you add new dependencies to <span class="icon file">package.json</span>.)</span> <br> 
            (2) Upload it to Intel® Edison, and <br>
            (3) Run the application.</p>
          <p><img src="/sensors/temp_sensor/xdk_deploy_steps.png" alt="" ></p>
        </li>

      </ol>


      <div id="next-steps" class="callout done">
        <p><!-- You should now be seeing the temperature displayed on the LCD. --></p>
        <p><a href="../index.html#done-temp-sensor" class="link-button centered">Continue to the next step »</a></p>
      </div>

      <!-- <h2>References</h2> -->


    </div><!-- end .content -->
  </body>
</html>